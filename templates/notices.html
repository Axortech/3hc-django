{% load static %}
<!DOCTYPE html>
<html lang="zxx">

<head>
  <meta charset="utf-8" />
  <title>BUILDSTATE - Notices</title>
  <meta content="" name="description" />
  <meta content="" name="author" />
  <meta content="" name="keywords" />
  <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" />
  <!-- favicon -->
  <link href="{% static 'img/favicon.png' %}" rel="icon" sizes="32x32" type="image/png" />
  <!-- Bootstrap CSS -->
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
  <!-- font themify CSS -->
  <link rel="stylesheet" href="{% static 'css/themify-icons.css' %}" />
  <!-- font awesome CSS -->
  <link href="{% static 'font-awesome/css/font-awesome.css' %}" rel="stylesheet" />
  <!-- on3step CSS -->
  <link href="{% static 'css/animated-on3step.css' %}" rel="stylesheet" />
  <link href="{% static 'css/owl.carousel.css' %}" rel="stylesheet" />
  <link href="{% static 'css/owl.theme.css' %}" rel="stylesheet" />
  <link href="{% static 'css/owl.transitions.css' %}" rel="stylesheet" />
  <link href="{% static 'css/on3step-style.css' %}" rel="stylesheet" />
  <link href="{% static 'css/queries-on3step.css' %}" media="all" rel="stylesheet" type="text/css" />
</head>

<body>
  <!-- preloader -->
  <div class="bg-preloader"></div>
  <div class="preloader">
    <div class="mainpreloader">
      <span></span>
    </div>
  </div>
  <!-- preloader end -->

  <!-- content wraper -->
  <div class="content-wrapper">
    {% include "components/header.html" %}
    <!-- subheader -->
    <section id="subheader">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <h1>
              NOTICES
            </h1>
          </div>
          <!-- devider -->

          <div class="col-md-12">
            <div class="devider-page">
              <div class="devider-img-right">
              </div>
            </div>
          </div>

          <div class="col-md-12">
            <ul class="subdetail">
              <li>
                <a href="index.html">Home</a>
              </li>

              <li class="sep">/
              </li>

              <li>NOTICES
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>
    <!-- subheader end -->
    <!-- Notices Page Header -->
    <section aria-label="Notices" class="blog-1 page-top"
      style="min-height: 250px; display: flex; align-items: center;">
      <div class="container" style="width: 100%;">
        <div class="row">
          <div class="col-md-12">
            <div class="breadcrumb-box">
              <h1>NOTICES & ANNOUNCEMENTS</h1>
              <p>Stay informed with the latest updates and important announcements</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Notices Content -->
    <section aria-label="notices-list" class="news-1">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <!-- Notices Container -->
            <div id="noticesContainer" class="notices-list">
              <div class="text-center" style="padding: 40px;">
                <p>Loading notices...</p>
              </div>
            </div>

            <!-- Pagination Controls -->
            <div id="paginationControls" style="display: none; margin-top: 40px; text-align: center;">
              <nav aria-label="Notices pagination">
                <ul class="pagination" style="justify-content: center;">
                  <li class="page-item" id="prevBtn" style="display: none;">
                    <a class="page-link" href="#" style="color: #ff6600; cursor: pointer;"
                      onclick="previousPage(event)">← Previous</a>
                  </li>

                  <li class="page-item" style="margin: 0 10px;">
                    <span class="page-link" style="background: transparent; border: none;">
                      Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                  </li>

                  <li class="page-item" id="nextBtn" style="display: none;">
                    <a class="page-link" href="#" style="color: #ff6600; cursor: pointer;"
                      onclick="nextPage(event)">Next →</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </section>

    {% include "components/footer.html" %}
  </div>
  <!-- content wraper end -->

  <!-- plugin JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-appear/0.3.3/jquery.appear.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>
  <script src="{% static 'js/on3step.js' %}"></script>

  <script>
    let currentPageNum = 1;
    let nextPageUrl = null;
    let previousPageUrl = null;
    let totalCount = 0;
    let pageSize = 10;

    // Fetch notices from API with pagination
    async function fetchNotices(url = '/api/notices/published/') {
      const container = document.getElementById('noticesContainer');
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Handle both paginated and non-paginated responses
        let notices = [];
        if (Array.isArray(data)) {
          // Non-paginated response
          notices = data;
          totalCount = data.length;
          nextPageUrl = null;
          previousPageUrl = null;
        } else if (data.results) {
          // Paginated response
          notices = data.results;
          nextPageUrl = data.next;
          previousPageUrl = data.previous;
          totalCount = data.count || 0;
          pageSize = data.results.length;

          // Calculate current page and total pages
          if (url.includes('page=')) {
            const pageMatch = url.match(/page=(\d+)/);
            currentPageNum = pageMatch ? parseInt(pageMatch[1]) : 1;
          } else {
            currentPageNum = 1;
          }

          const totalPages = Math.ceil(totalCount / pageSize);
          document.getElementById('currentPage').textContent = currentPageNum;
          document.getElementById('totalPages').textContent = totalPages;

          // Show/hide pagination controls
          const paginationControls = document.getElementById('paginationControls');
          if (totalPages > 1) {
            paginationControls.style.display = 'block';
            document.getElementById('prevBtn').style.display = previousPageUrl ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = nextPageUrl ? 'block' : 'none';
          } else {
            paginationControls.style.display = 'none';
          }
        }

        if (notices.length === 0) {
          container.innerHTML = '<p class="text-center" style="padding: 40px; color: #999;">No notices available at the moment.</p>';
          return;
        }

        let html = '<div class="row">';
        notices.forEach(notice => {
          const noticeDate = new Date(notice.notice_date);
          const dateStr = noticeDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
          const priorityClass = notice.priority === 'urgent' ? 'badge-danger' : notice.priority === 'high' ? 'badge-warning' : notice.priority === 'low' ? 'badge-info' : 'badge-secondary';
          const stickyBadge = notice.is_sticky ? '<span class="badge" style="background-color: #ff6600; padding: 6px 12px; border-radius: 4px; color: white; font-weight: bold; margin-left: 8px;">PINNED</span>' : '';

          html += `
              <div class="col-md-12" style="margin-bottom: 30px;">
                <div class="news-item" style="padding: 20px; background: white; border-left: 4px solid ${notice.is_sticky ? '#ff6600' : '#007bff'}; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; cursor: pointer;" 
                     onclick="viewNoticeDetail('${notice.slug}', event)"
                     onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)'; this.style.transform='translateY(-2px)'"
                     onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)'">
                  
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1;">
                      <h4 style="margin: 0 0 10px 0; color: #333; cursor: pointer;">${notice.title || 'Untitled'}</h4>
                      <small style="color: #999; display: flex; align-items: center; gap: 10px;">
                        <span>${dateStr}</span>
                        ${notice.view_count ? `<span style="color: #ccc;">|</span><span>${notice.view_count} views</span>` : ''}
                      </small>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">
                      ${notice.priority ? `<span class="badge ${priorityClass}" style="padding: 6px 12px; border-radius: 4px; color: white; font-weight: bold; font-size: 11px;">${notice.priority.toUpperCase()}</span>` : ''}
                      ${stickyBadge}
                    </div>
                  </div>
                  
                  <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">${notice.excerpt || (notice.content ? notice.content.substring(0, 200) + '...' : 'No content')}</p>
                  
                  <div style="display: flex; gap: 10px; align-items: center;">
                    ${notice.attachment ? `<a href="${notice.attachment}" style="display: inline-flex; align-items: center; gap: 5px; padding: 8px 14px; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 4px; font-size: 12px; transition: all 0.3s ease;" onmouseover="this.style.background='#ff6600'; this.style.color='white';" onmouseout="this.style.background='#f0f0f0'; this.style.color='#333';" onclick="event.stopPropagation();">
                      <span class="ti-download"></span> Download
                    </a>` : ''}
                    <span style="color: #ccc; font-size: 12px;">→ Click to view full notice</span>
                  </div>
                </div>
              </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
      } catch (error) {
        console.error('Error fetching notices:', error);
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px;">
              <p style="color: #999; margin: 0;">Error loading notices. Please try again later.</p>
              <small style="color: #ccc; display: block; margin-top: 10px;">Debug: ${error.message}</small>
            </div>
          `;
      }
    }

    // Navigate to next page
    function nextPage(event) {
      event.preventDefault();
      if (nextPageUrl) {
        fetchNotices(nextPageUrl);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // Navigate to previous page
    function previousPage(event) {
      event.preventDefault();
      if (previousPageUrl) {
        fetchNotices(previousPageUrl);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // View individual notice detail
    function viewNoticeDetail(slug, event) {
      if (event && event.target.closest('a')) {
        return; // Don't navigate if clicking on a link
      }
      window.location.href = `/notices/${slug}/`;
    }

    // Load notices when page loads
    document.addEventListener('DOMContentLoaded', function () {
      fetchNotices();
    });
  </script>
</body>

</html>