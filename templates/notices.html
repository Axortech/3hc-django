{% load static %}
<!DOCTYPE html>
<html lang="zxx">
  <head>
    <meta charset="utf-8" />
    <title>BUILDSTATE - Notices</title>
    <meta content="" name="description" />
    <meta content="" name="author" />
    <meta content="" name="keywords" />
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" />
    <!-- favicon -->
    <link href="{% static 'img/favicon.png' %}" rel="icon" sizes="32x32" type="image/png" />
    <!-- Bootstrap CSS -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
    <!-- font themify CSS -->
    <link rel="stylesheet" href="{% static 'css/themify-icons.css' %}" />
    <!-- font awesome CSS -->
    <link href="{% static 'font-awesome/css/font-awesome.css' %}" rel="stylesheet" />
    <!-- on3step CSS -->
    <link href="{% static 'css/animated-on3step.css' %}" rel="stylesheet" />
    <link href="{% static 'css/owl.carousel.css' %}" rel="stylesheet" />
    <link href="{% static 'css/owl.theme.css' %}" rel="stylesheet" />
    <link href="{% static 'css/owl.transitions.css' %}" rel="stylesheet" />
    <link href="{% static 'css/on3step-style.css' %}" rel="stylesheet" />
    <link href="{% static 'css/queries-on3step.css' %}" media="all" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <!-- preloader -->
    <div class="bg-preloader"></div>
    <div class="preloader">
      <div class="mainpreloader">
        <span></span>
      </div>
    </div>
    <!-- preloader end -->

    <!-- content wraper -->
    <div class="content-wrapper">
      {% include "components/header.html" %}

      <!-- Notices Page Header -->
      <section aria-label="Notices" class="blog-1 page-top" style="background: url('{% static 'img/portfolio-top.jpg' %}') no-repeat center; background-size: cover;">
        <div class="bg-alpha-80">
          <div class="container">
            <div class="row">
              <div class="col-md-12">
                <div class="breadcrumb-box">
                  <h1>NOTICES & ANNOUNCEMENTS</h1>
                  <p>Stay informed with the latest updates and important announcements</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Notices Content -->
      <section aria-label="notices-list" class="news-1">
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <!-- Notices Container -->
              <div id="noticesContainer" class="notices-list">
                <div class="text-center">
                  <p>Loading notices...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Stay Updated Section -->
          <div class="row" style="margin-top: 60px; padding: 40px; background: #f8f9fa; border-radius: 8px;">
            <div class="col-md-12 text-center">
              <h3 style="margin-bottom: 20px;">Stay Updated With Us</h3>
              <p style="margin-bottom: 30px; color: #666;">Subscribe to our newsletter to receive the latest notices and announcements directly in your inbox.</p>
              <button type="button" class="btn-form popup-form" style="padding: 12px 30px; background: #ff6600; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" href="#subwrap" title="Open subscription form">
                Subscribe Now
              </button>
            </div>
          </div>
        </div>
      </section>

      {% include "components/footer.html" %}
    </div>
    <!-- content wraper end -->

    <!-- Subscribe start -->
    <div class="white-popup-block mfp-hide animbounceInDown" data-time="0" id="subwrap">
      <h5>PLEASE FILL YOUR EMAIL BELOW</h5>

      <div class="space-half"></div>

      <form action="subscribe.php" id="subscribe" method="post" name="subscribe">
        <label for="subscribeemail" style="display: none;">Email Address</label>
        <input class="subscribfield subscribeemail" id="subscribeemail" name="subscribeemail" type="text" placeholder="your email" title="Enter your email to subscribe" />
        <button class="btn-form" id="submit-2" type="submit">Subscribe</button>
      </form>

      <div class="subscribesuccess">Thank you for fill your email</div>
    </div>
    <!-- Subscribe end -->

    <!-- plugin JS -->
    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/bootstrap.js' %}"></script>
    <script src="{% static 'js/jquery.easing.js' %}"></script>
    <script src="{% static 'js/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'js/jquery.appear.js' %}"></script>
    <script src="{% static 'js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'js/jquery.magnific-popup.min.js' %}"></script>
    <script src="{% static 'js/jquery.isotope.min.js' %}"></script>
    <script src="{% static 'js/jquery.masonry.min.js' %}"></script>
    <script src="{% static 'js/parallax.js' %}"></script>
    <script src="{% static 'js/on3step-functions.js' %}"></script>

    <script>
      // Fetch notices from API
      async function fetchNotices() {
        const container = document.getElementById('noticesContainer');
        try {
          // Try the public endpoint first
          const response = await fetch('/api/notices/published/', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // Check if response is JSON array or object with results
          const data = await response.json();
          const notices = Array.isArray(data) ? data : (data.results || []);

          if (notices.length === 0) {
            container.innerHTML = '<p class="text-center" style="padding: 40px; color: #999;">No notices available at the moment.</p>';
            return;
          }

          let html = '<div class="row">';
          notices.forEach(notice => {
            const noticeDate = new Date(notice.notice_date);
            const dateStr = noticeDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const priorityClass = notice.priority === 'urgent' ? 'badge-danger' : notice.priority === 'high' ? 'badge-warning' : 'badge-info';

            html += `
              <div class="col-md-12" style="margin-bottom: 30px;">
                <div class="news-item" style="padding: 20px; background: white; border-left: 4px solid #ff6600; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap;">
                    <div>
                      <h4 style="margin: 0 0 10px 0; color: #333;">${notice.title || 'Untitled'}</h4>
                      <small style="color: #999;">${dateStr}</small>
                    </div>
                    ${notice.priority ? `<span class="badge ${priorityClass}" style="padding: 6px 12px; border-radius: 4px; color: white; font-weight: bold;">${notice.priority.toUpperCase()}</span>` : ''}
                  </div>
                  
                  <p style="color: #666; margin-bottom: 15px;">${notice.excerpt || notice.content ? notice.content.substring(0, 200) : 'No content'}</p>
                  
                  ${notice.attachment ? `<a href="${notice.attachment}" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #ff6600; color: white; text-decoration: none; border-radius: 4px; font-size: 12px;">Download Attachment</a>` : ''}
                </div>
              </div>
            `;
          });
          html += '</div>';

          container.innerHTML = html;
        } catch (error) {
          console.error('Error fetching notices:', error);
          container.innerHTML = `
            <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px;">
              <p style="color: #999; margin: 0;">Error loading notices. Please try again later.</p>
              <small style="color: #ccc; display: block; margin-top: 10px;">Debug: ${error.message}</small>
            </div>
          `;
        }
      }

      // Load notices when page loads
      document.addEventListener('DOMContentLoaded', function() {
        fetchNotices();
      });
    </script>
  </body>
</html>
